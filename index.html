
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Join the ultimate Efootball Championship! View live brackets, register your team, and follow all the results for the 2025 season.">
    <meta name="keywords" content="efootball, tournament, championship, gaming, esports">
    <meta name="author" content="Salman Syed">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFOOTBALL CHAMPIONSHIP BY SALMAN SYED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ucl-dark': '#001c4d',
                        'ucl-card': '#002b70',
                        'ucl-accent': '#00ccff',
                        'ucl-text': '#ffffff',
                        'ucl-highlight': '#005fcc',
                        'ucl-success': '#10b981',
                        'ucl-warning': '#f59e0b',
                        'ucl-danger': '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a192f 0%, #1a365d 100%);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background-color: #00ccff; 
            border-radius: 4px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-track { 
            background-color: #1a0d1e; 
        }
        
        .tab-button {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .section-header-bg {
            background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
            border-bottom: 2px solid #00ccff;
        }
        
        .stat-card {
            background: linear-gradient(145deg, #002b70 0%, #003399 100%);
            border: 1px solid rgba(0, 204, 255, 0.2);
            border-radius: 12px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes news-scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .news-scroller {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: news-scroll 30s linear infinite;
        }
        
        .news-scroller:hover {
            animation-play-state: paused;
        }
        
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://i.postimg.cc/nzwxmDN6/unnamed-(20).jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 100;
        }
        
        .welcome-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.7) 100%);
        }
        
        .enter-button-container {
            position: absolute;
            bottom: 15%;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
        }
        
        .hidden-button {
            background: transparent;
            border: none;
            color: transparent;
            cursor: pointer;
            padding: 30px 60px;
            font-size: 0;
            position: relative;
            width: 300px;
            height: 80px;
        }
        
        .hidden-button:hover {
            background: rgba(0, 204, 255, 0.1);
            border-radius: 40px;
            outline: 3px solid rgba(0, 204, 255, 0.2);
        }
        
        .match-card {
            background: linear-gradient(135deg, rgba(0, 43, 112, 0.8) 0%, rgba(0, 28, 77, 0.9) 100%);
            border: 1px solid rgba(0, 204, 255, 0.3);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .match-card:hover {
            border-color: #00ccff;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.3);
        }
        
        .match-stat-input {
            width: 60px;
            height: 36px;
            text-align: center;
            font-size: 14px;
            padding: 6px;
            margin: 0 3px;
        }
        
        .tournament-logo {
            filter: drop-shadow(0 0 10px rgba(0, 204, 255, 0.5));
        }
        
        .team-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }
        
        @media (max-width: 768px) {
            .team-name {
                max-width: 80px;
            }
            
            .match-card-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .score-container {
                margin: 10px 0;
            }
            
            .match-stat-input {
                width: 50px;
                height: 32px;
                font-size: 12px;
                padding: 4px;
                margin: 0 2px;
            }
            
            .hidden-button {
                width: 250px;
                height: 70px;
                padding: 25px 50px;
            }
        }
    </style>
</head>
<body class="bg-ucl-dark text-ucl-text min-h-screen overflow-x-hidden">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="welcome-screen flex items-center justify-center fade-in">
        <div class="enter-button-container">
            <button id="enter-app-btn" class="hidden-button">
                LET ME IN
            </button>
        </div>
    </div>

    <!-- Main Application (Hidden Initially) -->
    <div id="main-app" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 w-full">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center bg-gradient-to-r from-blue-900 to-blue-800 p-4 rounded-2xl shadow-2xl mb-8 border-b-4 border-ucl-accent">
            <div class="flex items-center space-x-4">
                <div class="tournament-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/f3/Logo_UEFA_Champions_League.png" 
                         alt="UCL Logo" 
                         class="w-12 h-12">
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">EFOOTBALL CHAMPIONSHIP</h1>
                    <p class="text-sm text-ucl-accent">BY SALMAN SYED</p>
                </div>
            </div>
            
            <div id="auth-status" class="mt-4 sm:mt-0 flex items-center space-x-2">
                <i id="user-icon" class="ph-bold ph-user-circle text-2xl text-ucl-accent"></i>
                <div>
                    <span id="user-display" class="font-semibold">Guest</span>
                    <div class="text-xs text-ucl-accent/70">Tournament Viewer</div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-gradient-to-r from-blue-800 to-blue-700 p-2 rounded-xl shadow-lg mb-8 sticky top-4 z-40 backdrop-blur-sm bg-opacity-90">
            <div class="flex flex-wrap justify-around text-center">
                <div data-tab="admin" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent hover:bg-blue-900/50 transition-all">
                    <i class="ph-bold ph-lock mr-2"></i> ADMIN
                </div>
                <div data-tab="fixtures" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent hover:bg-blue-900/50 transition-all">
                    <i class="ph-bold ph-calendar-blank mr-2"></i> FIXTURES
                </div>
                <div data-tab="points" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent hover:bg-blue-900/50 transition-all">
                    <i class="ph-bold ph-table mr-2"></i> POINTS TABLE
                </div>
                <div data-tab="stats" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent hover:bg-blue-900/50 transition-all">
                    <i class="ph-bold ph-chart-bar mr-2"></i> STATS
                </div>
            </div>
        </nav>

        <!-- News Strip -->
        <div id="news-strip-container" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-800 to-cyan-800 text-white py-3 px-4 shadow-2xl z-50 border-t-2 border-ucl-accent hidden">
            <div class="max-w-6xl mx-auto flex items-center">
                <span class="font-bold whitespace-nowrap mr-6 px-4 py-1 bg-white text-blue-900 rounded-full text-sm uppercase tracking-wider shadow-lg">
                    <i class="ph-bold ph-megaphone mr-2"></i> LIVE NEWS
                </span>
                <div class="flex-1 overflow-hidden">
                    <div id="news-text" class="news-scroller text-lg font-bold"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="tab-content" class="space-y-8 fade-in w-full">

            <!-- Admin Tab -->
            <div id="admin" class="tab-pane space-y-8 hidden w-full">
                <!-- Admin Authentication -->
                <div id="admin-auth-panel" class="stat-card p-8 w-full">
                    <h2 class="text-2xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                        <i class="ph-bold ph-lock-key text-2xl mr-3 text-ucl-accent"></i> Admin Access
                    </h2>
                    <form id="admin-auth-form" class="space-y-4">
                        <input type="password" id="admin-password" placeholder="Enter Admin Password" required
                               class="w-full p-4 bg-blue-900/50 border-2 border-blue-700 rounded-xl text-white placeholder-blue-300 focus:border-ucl-accent focus:ring-2 focus:ring-ucl-accent transition-all">
                        <button type="submit"
                                class="w-full p-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold rounded-xl shadow-lg hover:from-blue-700 hover:to-cyan-700 transition-all transform hover:scale-[1.02]">
                            <i class="ph-bold ph-key mr-2"></i> UNLOCK ADMIN PANEL
                        </button>
                        <div id="admin-auth-message" class="text-center text-sm mt-2"></div>
                    </form>
                </div>

                <!-- Admin Panel (Hidden Initially) -->
                <div id="admin-panel" class="space-y-8 hidden w-full">
                    <!-- Current Tournament Status -->
                    <div class="stat-card p-8 w-full">
                        <h3 class="text-xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                            <i class="ph-bold ph-trophy mr-3 text-ucl-accent"></i> Current Tournament
                        </h3>
                        <div id="current-tournament-status" class="space-y-4 w-full">
                            <div class="text-center py-8 text-blue-200">Loading tournament status...</div>
                        </div>
                    </div>

                    <!-- Start New Tournament -->
                    <div class="stat-card p-8 w-full">
                        <h3 class="text-xl font-bold text-white section-header-bg p-4 rounded-xl mb-6">Start New Tournament</h3>
                        <form id="start-tournament-form" class="space-y-6 w-full">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                                <div>
                                    <label class="block text-sm font-semibold text-blue-200 mb-2">Tournament Type</label>
                                    <select id="tournament-type" class="w-full p-3 bg-blue-900/50 border-2 border-blue-700 rounded-lg text-white">
                                        <option value="league">League Tournament</option>
                                        <option value="group_knockout">Group Stage & Knockout</option>
                                    </select>
                                </div>
                                
                                <div id="league-rounds-container">
                                    <label class="block text-sm font-semibold text-blue-200 mb-2">Matches Per Team</label>
                                    <input type="number" id="num-rounds" value="2" min="1" class="w-full p-3 bg-blue-900/50 border-2 border-blue-700 rounded-lg text-white">
                                </div>
                                
                                <div id="group-stage-options" class="hidden">
                                    <label class="block text-sm font-semibold text-blue-200 mb-2">Number of Groups</label>
                                    <input type="number" id="groups-count" value="4" min="1" class="w-full p-3 bg-blue-900/50 border-2 border-blue-700 rounded-lg text-white">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-blue-200 mb-2">Teams Count</label>
                                    <input type="number" id="teams-count" value="16" min="4" step="2" class="w-full p-3 bg-blue-900/50 border-2 border-blue-700 rounded-lg text-white">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-blue-200 mb-2">Start Date</label>
                                    <input type="date" id="start-date" class="w-full p-3 bg-blue-900/50 border-2 border-blue-700 rounded-lg text-white">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-blue-200 mb-2">Team & Player Assignment</label>
                                <textarea id="teams-and-players" rows="16" class="w-full p-4 bg-blue-900/50 border-2 border-blue-700 rounded-xl text-white font-mono text-sm">
Manchester United : @~Sonofsardar
Manchester City : @~Sayed Maroof Shah
Liverpool : @~Asad Ullah
Chelsea : @~Abdul Hamid Thoba
Tottenham Hotspur : @~An
Arsenal : @~Hassan Ahad
Fulham : @‚Å®~SwordFish‚Å©
Nottingham Forest : Muazamüòí
AFC Bournemouth : @‚Å®~Muhammad Yousuf‚Å©
Crystal Palace : @‚Å®CADET SYED üòé‚Å©
Wolverhampton Wanderers : @~Muhammad Amjad
Sunderland : @sanaullah
Newcastle United : @~ khan
Brighton & Hove Albion : @~Imadkhan
Aston Villa : @~SIKANDAR SHAMS
Brentford : @asim
                                </textarea>
                            </div>

                            <button type="submit" class="w-full p-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:from-green-700 hover:to-emerald-700 transition-all transform hover:scale-[1.02]">
                                <i class="ph-bold ph-calendar-plus text-xl mr-2"></i> GENERATE FIXTURES & START TOURNAMENT
                            </button>
                            <div id="start-message" class="text-center text-sm"></div>
                        </form>
                    </div>

                    <!-- Tournament News -->
                    <div class="stat-card p-8 w-full">
                        <h3 class="text-xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                            <i class="ph-bold ph-megaphone mr-3 text-ucl-accent"></i> Tournament News
                        </h3>
                        <div class="space-y-4">
                            <textarea id="admin-news-input" rows="4" placeholder="Enter tournament news here..." class="w-full p-4 bg-blue-900/50 border-2 border-blue-700 rounded-xl text-white"></textarea>
                            <div class="flex flex-wrap gap-4">
                                <button id="publish-news-btn" class="flex-1 p-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold rounded-xl hover:from-blue-700 hover:to-cyan-700 transition-all">
                                    <i class="ph-bold ph-paper-plane-tilt mr-2"></i> PUBLISH NEWS
                                </button>
                                <button id="clear-news-btn" class="flex-1 p-4 bg-gradient-to-r from-red-600 to-pink-600 text-white font-bold rounded-xl hover:from-red-700 hover:to-pink-700 transition-all">
                                    <i class="ph-bold ph-trash mr-2"></i> CLEAR NEWS
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Match Results -->
                    <div class="stat-card p-8 w-full">
                        <h3 class="text-xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                            <i class="ph-bold ph-upload-simple mr-3 text-ucl-accent"></i> Upload Match Results
                        </h3>
                        <div id="admin-results-content">
                            <div class="text-center py-8 text-blue-200">
                                Select an active tournament above to load results panel.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixtures Tab -->
            <div id="fixtures" class="tab-pane space-y-8 w-full">
                <div class="stat-card p-8 w-full">
                    <h2 id="fixtures-header" class="text-2xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                        <i class="ph-bold ph-calendar-check text-2xl mr-3 text-ucl-accent"></i> Tournament Fixtures
                    </h2>
                    
                    <div id="group-tabs-container" class="mb-6 hidden bg-blue-900/50 p-2 rounded-xl w-full">
                        <!-- Group tabs will be generated here -->
                    </div>

                    <div id="fixtures-content" class="w-full">
                        <div class="text-center py-12">
                            <i class="ph-bold ph-calendar-blank text-5xl text-blue-400 mb-4"></i>
                            <p class="text-xl text-blue-200">Tournament fixtures will appear here once the schedule is generated.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Points Table Tab -->
            <div id="points" class="tab-pane space-y-8 hidden w-full">
                <div class="stat-card p-8 w-full">
                    <h2 id="points-header" class="text-2xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                        <i class="ph-bold ph-list-numbers text-2xl mr-3 text-ucl-accent"></i> Points Table
                    </h2>
                    
                    <div id="points-table-content" class="overflow-x-auto w-full">
                        <div class="text-center py-12">
                            <i class="ph-bold ph-table text-5xl text-blue-400 mb-4"></i>
                            <p class="text-xl text-blue-200">Upload results in the Admin tab to populate the points table.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats" class="tab-pane space-y-8 hidden w-full">
                <div class="stat-card p-8 w-full">
                    <h2 class="text-2xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                        <i class="ph-bold ph-chart-line text-2xl mr-3 text-ucl-accent"></i> Tournament Statistics
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 w-full">
                        <!-- Golden Boot -->
                        <div class="bg-gradient-to-br from-blue-900/80 to-blue-800/80 p-6 rounded-2xl border-2 border-yellow-500/30">
                            <h4 class="font-bold text-white text-lg mb-4 flex items-center">
                                <i class="ph-bold ph-football mr-2 text-yellow-400"></i> GOLDEN BOOT üèÜ
                            </h4>
                            <ul id="scorers-list" class="space-y-3"></ul>
                        </div>

                        <!-- Best Defense -->
                        <div class="bg-gradient-to-br from-blue-900/80 to-blue-800/80 p-6 rounded-2xl border-2 border-blue-500/30">
                            <h4 class="font-bold text-white text-lg mb-4 flex items-center">
                                <i class="ph-bold ph-shield-check mr-2 text-blue-400"></i> BEST DEFENSE üõ°Ô∏è
                            </h4>
                            <ul id="defense-list" class="space-y-3"></ul>
                        </div>

                        <!-- Top Passers -->
                        <div class="bg-gradient-to-br from-blue-900/80 to-blue-800/80 p-6 rounded-2xl border-2 border-green-500/30">
                            <h4 class="font-bold text-white text-lg mb-4 flex items-center">
                                <i class="ph-bold ph-arrows-left-right mr-2 text-green-400"></i> TOP PASSERS üéØ
                            </h4>
                            <ul id="passers-list" class="space-y-3"></ul>
                        </div>

                        <!-- Top Tacklers -->
                        <div class="bg-gradient-to-br from-blue-900/80 to-blue-800/80 p-6 rounded-2xl border-2 border-red-500/30">
                            <h4 class="font-bold text-white text-lg mb-4 flex items-center">
                                <i class="ph-bold ph-sword mr-2 text-red-400"></i> TOP TACKLERS ‚öîÔ∏è
                            </h4>
                            <ul id="tacklers-list" class="space-y-3"></ul>
                        </div>

                        <!-- Top Savers -->
                        <div class="bg-gradient-to-br from-blue-900/80 to-blue-800/80 p-6 rounded-2xl border-2 border-cyan-500/30">
                            <h4 class="font-bold text-white text-lg mb-4 flex items-center">
                                <i class="ph-bold ph-hand mr-2 text-cyan-400"></i> TOP SAVERS üß§
                            </h4>
                            <ul id="savers-list" class="space-y-3"></ul>
                        </div>
                    </div>
                    
                    <div id="stats-misc" class="text-center pt-8 text-blue-200 text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ========== CONSTANTS & CONFIGURATION ==========
        const ADMIN_PASSWORD = "EFOOTBALL2026";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAKXE_sklR_wpRYUaV-l7jZFHbEOhN0GZU",
            authDomain: "efootball-2026.firebaseapp.com",
            databaseURL: "https://efootball-2026-default-rtdb.firebaseio.com",
            projectId: "efootball-2026",
            storageBucket: "efootball-2026.firebasestorage.app",
            messagingSenderId: "189433778137",
            appId: "1:189433778137:web:10517370da0990108d93c8",
            measurementId: "G-3ZQ3KGXPFG"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const tournamentRef = database.ref('tournament/settings');
        const newsRef = database.ref('tournament/news');
        
        // Global Variables
        let isAdmin = false;
        let currentTab = 'fixtures';
        let tournamentData = null;
        let activeGroup = null;
        
        // Team Logo Mapping
        const TEAM_LOGOS = {
            'Manchester United': 'https://crests.football-data.org/66.png',
            'Manchester City': 'https://crests.football-data.org/65.png',
            'Liverpool': 'https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg',
            'Chelsea': 'https://crests.football-data.org/61.png',
            'Tottenham Hotspur': 'https://crests.football-data.org/73.png',
            'Arsenal': 'https://crests.football-data.org/57.png',
            'Fulham': 'https://crests.football-data.org/63.png',
            'Nottingham Forest': 'https://crests.football-data.org/351.png',
            'AFC Bournemouth': 'https://crests.football-data.org/1044.png',
            'Crystal Palace': 'https://crests.football-data.org/341.png',
            'Wolverhampton Wanderers': 'https://crests.football-data.org/76.png',
            'Sunderland': 'https://crests.football-data.org/394.png',
            'Newcastle United': 'https://crests.football-data.org/62.png',
            'Brighton & Hove Albion': 'https://crests.football-data.org/397.png',
            'Aston Villa': 'https://crests.football-data.org/58.png',
            'Brentford': 'https://crests.football-data.org/404.png'
        };

        // ========== UTILITY FUNCTIONS ==========
        const showMessage = (elementId, message, isError = true) => {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = `text-sm mt-2 text-center ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => el.textContent = '', 5000);
        };

        const getTeamLogoHtml = (teamName, sizeClass = 'w-8 h-8') => {
            const logoUrl = TEAM_LOGOS[teamName] || 'https://cdn-icons-png.flaticon.com/512/53/53254.png';
            return `<img src="${logoUrl}" alt="${teamName}" class="${sizeClass} object-contain mr-2" onerror="this.src='https://cdn-icons-png.flaticon.com/512/53/53254.png'">`;
        };

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const getPlayerName = (teamName, players) => {
            if (!teamName || teamName.startsWith('Winner of') || teamName.startsWith('TBD Rank')) {
                return '';
            }
            const playerName = players && players[teamName];
            if (playerName) {
                return `<span class="text-blue-300 text-xs ml-1">(${playerName})</span>`;
            }
            return '';
        };

        // ========== WELCOME SCREEN HANDLER ==========
        document.getElementById('enter-app-btn').addEventListener('click', () => {
            document.getElementById('welcome-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('main-app').classList.add('fade-in');
                initializeApp();
            }, 500);
        });

        // ========== TOURNAMENT SCHEDULING ==========
        const generateRoundRobinMatches = (teams, roundOffset, leagueRoundStart) => {
            let n = teams.length;
            if (n % 2 !== 0) n++;
            let currentTeams = [...teams];
            while (currentTeams.length < n) currentTeams.push('BYE');

            const roundMatches = [];
            const totalRounds = n - 1;
            
            for (let round = 1; round <= totalRounds; round++) {
                const matchesInRound = [];
                const half = n / 2;
                
                for (let i = 0; i < half; i++) {
                    const home = currentTeams[i];
                    const away = currentTeams[n - 1 - i];
                    
                    if (home !== 'BYE' && away !== 'BYE') {
                        matchesInRound.push({
                            id: `${leagueRoundStart + roundOffset + round}-${matchesInRound.length}`,
                            home: home,
                            away: away,
                            homeScore: null,
                            awayScore: null,
                            // 6 STATS FIELDS FOR BOTH TEAMS
                            homePasses: null,
                            homeTackles: null,
                            homeSaves: null,
                            awayPasses: null,
                            awayTackles: null,
                            awaySaves: null
                        });
                    }
                }
                
                if (matchesInRound.length > 0) {
                    roundMatches.push({ 
                        round: leagueRoundStart + roundOffset + round, 
                        matches: matchesInRound 
                    });
                }

                // Rotate teams
                if (currentTeams.length > 2) {
                    const firstTeam = currentTeams[0];
                    const rotatingPart = currentTeams.slice(1);
                    const lastElement = rotatingPart.pop();
                    const rotatedPart = [lastElement, ...rotatingPart];
                    currentTeams = [firstTeam, ...rotatedPart];
                }
            }
            return roundMatches;
        };

        // ========== RESTORED GROUP STAGE & KNOCKOUT LOGIC ==========
        const generateGroupKnockoutSchedule = (teams, groupsCount, startDateStr) => {
            // 1. Assign Teams to Groups
            const groupSize = teams.length / groupsCount;
            if (groupSize % 1 !== 0) return { schedule: [], groups: {} };
            
            const shuffledTeams = shuffleArray([...teams]);
            const groups = {};
            for (let i = 0; i < groupsCount; i++) {
                const groupName = `Group ${String.fromCharCode(65 + i)}`;
                groups[groupName] = shuffledTeams.slice(i * groupSize, (i + 1) * groupSize);
            }
            
            // 2. Generate Group Stage Matches (Round Robin in each group)
            let groupStageSchedule = [];
            
            for (const groupName in groups) {
                const groupTeams = groups[groupName];
                const matches = generateRoundRobinMatches(groupTeams, 0, 1);
                
                matches.forEach(round => {
                    round.matches.forEach(match => {
                        match.group = groupName;
                        match.id = `${groupName.replace(/\s/g, '_')}_${match.id}`;
                    });
                    
                    const roundNumber = round.round;
                    const existingRound = groupStageSchedule.find(r => r.round === roundNumber);
                    
                    const matchesToUse = round.matches.filter(m => m.home && m.away);

                    if (existingRound) {
                        existingRound.matches.push(...matchesToUse);
                    } else {
                        groupStageSchedule.push({ 
                            round: roundNumber, 
                            matches: matchesToUse
                        });
                    }
                });
            }
            
            // Sort group stage schedule by round number
            groupStageSchedule.sort((a, b) => a.round - b.round);
            
            // Assign dates to group stage (one round per day)
            let currentDate = new Date(startDateStr);
            const groupStageDated = [];
            
            groupStageSchedule.forEach((round, index) => {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + index);
                groupStageDated.push({
                    ...round,
                    date: date.toISOString().split('T')[0]
                });
            });

            // 3. Prepare Knockout Template
            let knockoutScheduleTemplate = [];
            let qualifyingTeamsCount;
            let koRoundCounter = groupStageDated.length > 0 ? groupStageDated[groupStageDated.length - 1].round : 0;

            if (teams.length >= 16) {
                qualifyingTeamsCount = 8;
                knockoutScheduleTemplate = [
                    { round: ++koRoundCounter, name: 'Quarter-Finals', matches: 4 },
                    { round: ++koRoundCounter, name: 'Semi-Finals', matches: 2 },
                    { round: ++koRoundCounter, name: 'Final', matches: 1 }
                ];
            } else {
                qualifyingTeamsCount = 4;
                knockoutScheduleTemplate = [
                    { round: ++koRoundCounter, name: 'Semi-Finals', matches: 2 },
                    { round: ++koRoundCounter, name: 'Final', matches: 1 }
                ];
            }
            
            let matchIdCounter = 0;
            const lastGroupMatchDate = groupStageDated.length > 0 ? 
                groupStageDated[groupStageDated.length - 1].date : startDateStr;
            let knockoutDate = new Date(lastGroupMatchDate);
            knockoutDate.setDate(knockoutDate.getDate() + 1);
            
            knockoutScheduleTemplate.forEach(roundTemplate => {
                const matches = [];
                const stageName = roundTemplate.name;
                for (let i = 0; i < roundTemplate.matches; i++) {
                    const matchName = roundTemplate.matches > 1 ? `${stageName} Match ${i + 1}` : 'Final';
                    matches.push({
                        id: `KNOCKOUT-${roundTemplate.round}-${matchIdCounter++}`,
                        home: `Winner of ${matchName} Home`,
                        away: `Winner of ${matchName} Away`,
                        homeScore: null,
                        awayScore: null,
                        homePasses: null,
                        homeTackles: null,
                        homeSaves: null,
                        awayPasses: null,
                        awayTackles: null,
                        awaySaves: null,
                        group: stageName,
                        knockout: true
                    });
                }
                groupStageDated.push({
                    round: roundTemplate.round,
                    date: knockoutDate.toISOString().split('T')[0],
                    matches: matches
                });
                knockoutDate.setDate(knockoutDate.getDate() + 1);
            });

            return { schedule: groupStageDated, groups: groups, qualifiers: qualifyingTeamsCount };
        };

        const generateLeagueSchedule = (teams, numRounds, startDateStr) => {
            let fullSchedule = [];
            const roundsPerBlock = teams.length - (teams.length % 2 === 0 ? 1 : 0);
            
            for (let r = 0; r < numRounds; r++) {
                const isFlippedRoundBlock = r % 2 !== 0;
                const roundOffset = r * roundsPerBlock;
                const oneBlockSchedule = generateRoundRobinMatches(teams, roundOffset, 1);
                
                oneBlockSchedule.forEach(round => {
                    const matches = round.matches.map(match => {
                        const [team1, team2] = isFlippedRoundBlock ? 
                            [match.away, match.home] : [match.home, match.away];
                        return { ...match, home: team1, away: team2 };
                    });
                    
                    fullSchedule.push({ 
                        round: round.round, 
                        matches: matches
                    });
                });
            }
            
            // Assign dates (one round per day)
            let currentDate = new Date(startDateStr);
            const datedSchedule = [];
            
            fullSchedule.forEach((round, index) => {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + index);
                datedSchedule.push({
                    ...round,
                    date: date.toISOString().split('T')[0]
                });
            });
            
            return datedSchedule;
        };

        // ========== ADMIN FUNCTIONS ==========
        const handleAdminAuth = (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('admin-auth-panel').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('user-icon').className = 'ph-bold ph-shield-check text-2xl text-green-400';
                document.getElementById('user-display').textContent = 'Admin User';
                document.getElementById('user-display').parentElement.innerHTML = `
                    <div>
                        <span id="user-display" class="font-bold text-green-400">Admin</span>
                        <div class="text-xs text-green-400/70">Tournament Manager</div>
                    </div>
                `;
                showMessage('admin-auth-message', 'Admin access granted!', false);
                
                // Load admin data
                if (tournamentData) {
                    renderAdminManagementPanel(tournamentData);
                    renderAdminResultsContent(tournamentData);
                }
            } else {
                showMessage('admin-auth-message', 'Incorrect password. Access denied.', true);
            }
        };

        const handleStartTournament = async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('tournament-type').value;
            const teamsCount = parseInt(document.getElementById('teams-count').value);
            const startDateStr = document.getElementById('start-date').value;
            const teamsAndPlayersRaw = document.getElementById('teams-and-players').value.trim();
            
            if (!teamsAndPlayersRaw) {
                showMessage('start-message', 'Team and Player assignment list cannot be empty.', true);
                return;
            }

            const teamLines = teamsAndPlayersRaw.split('\n').filter(line => line.trim() !== '');
            const teams = [];
            const players = {};

            teamLines.forEach(line => {
                const parts = line.split(':').map(p => p.trim());
                if (parts.length === 2) {
                    teams.push(parts[0]);
                    players[parts[0]] = parts[1];
                }
            });

            if (teams.length !== teamsCount) {
                showMessage('start-message', `Team count (${teams.length}) must match Teams Count field (${teamsCount}).`, true);
                return;
            }

            let scheduleData;
            let groupsData = null;
            let numRounds = 0;
            let knockoutQualifiers = 0;

            if (type === 'league') {
                numRounds = parseInt(document.getElementById('num-rounds').value);
                scheduleData = generateLeagueSchedule(teams, numRounds, startDateStr);
            } else {
                const groupsCount = parseInt(document.getElementById('groups-count').value);
                if (teamsCount % groupsCount !== 0 || groupsCount < 1) {
                    showMessage('start-message', 'Teams must be evenly divisible by number of groups.', true);
                    return;
                }
                
                const knockoutResult = generateGroupKnockoutSchedule(teams, groupsCount, startDateStr);
                scheduleData = knockoutResult.schedule;
                groupsData = knockoutResult.groups;
                knockoutQualifiers = knockoutResult.qualifiers;
                activeGroup = Object.keys(groupsData).sort()[0] || null;
            }

            const tournamentDataToSave = {
                type: type,
                teams: teams,
                players: players,
                groups: groupsData,
                numRoundsPerTeam: numRounds,
                knockoutQualifiers: knockoutQualifiers,
                startDate: startDateStr,
                schedule: scheduleData,
                organizerId: "ADMIN_USER",
                lastUpdated: new Date().toISOString()
            };

            try {
                await tournamentRef.set(tournamentDataToSave);
                showMessage('start-message', `Tournament started with ${scheduleData.length} matchdays!`, false);
                switchTab('fixtures');
            } catch (error) {
                console.error("Error saving tournament:", error);
                showMessage('start-message', 'Failed to save tournament data.', true);
            }
        };

        const handleUpdateResult = async (e) => {
            e.preventDefault();
            const form = e.target;
            const matchId = form.getAttribute('data-match-id');
            
            const homeScore = parseInt(form.querySelector('.score-input-home').value) || 0;
            const awayScore = parseInt(form.querySelector('.score-input-away').value) || 0;
            // HOME TEAM STATS
            const homePasses = parseInt(form.querySelector('.home-passes-input').value) || 0;
            const homeTackles = parseInt(form.querySelector('.home-tackles-input').value) || 0;
            const homeSaves = parseInt(form.querySelector('.home-saves-input').value) || 0;
            // AWAY TEAM STATS
            const awayPasses = parseInt(form.querySelector('.away-passes-input').value) || 0;
            const awayTackles = parseInt(form.querySelector('.away-tackles-input').value) || 0;
            const awaySaves = parseInt(form.querySelector('.away-saves-input').value) || 0;

            if (!tournamentData) {
                alert('No active tournament data found.');
                return;
            }
            
            let newSchedule = JSON.parse(JSON.stringify(tournamentData.schedule));
            let found = false;
            
            newSchedule = newSchedule.map(round => ({
                ...round,
                matches: round.matches.map(match => {
                    if (match.id === matchId) {
                        match.homeScore = homeScore;
                        match.awayScore = awayScore;
                        // UPDATE ALL 6 STATS FIELDS
                        match.homePasses = homePasses;
                        match.homeTackles = homeTackles;
                        match.homeSaves = homeSaves;
                        match.awayPasses = awayPasses;
                        match.awayTackles = awayTackles;
                        match.awaySaves = awaySaves;
                        found = true;
                    }
                    return match;
                })
            }));

            if (found) {
                try {
                    await tournamentRef.update({ 
                        schedule: newSchedule,
                        lastUpdated: new Date().toISOString()
                    });

                    const btn = form.querySelector('button[type="submit"]');
                    btn.innerHTML = `<i class="ph-bold ph-check text-lg"></i>`;
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = `<i class="ph-bold ph-floppy-disk text-lg"></i>`;
                        btn.classList.replace('bg-green-600', 'bg-blue-600');
                    }, 1000);
                } catch (error) {
                    console.error("Update error:", error);
                    alert('Failed to save result.');
                }
            }
        };

        // ========== STATISTICS CALCULATIONS ==========
        const calculateStandings = (teams, scheduleData, groups = {}) => {
            const standings = {};
            const stats = {
                passes: {},
                tackles: {},
                saves: {}
            };

            // Initialize standings with group information
            teams.forEach(team => {
                // Find which group this team belongs to
                let groupName = 'Overall';
                if (groups) {
                    for (const group in groups) {
                        if (groups[group].includes(team)) {
                            groupName = group;
                            break;
                        }
                    }
                }
                
                standings[team] = {
                    team: team,
                    group: groupName,
                    P: 0, W: 0, D: 0, L: 0,
                    GF: 0, GA: 0, GD: 0, Pts: 0,
                    passes: 0,
                    tackles: 0,
                    saves: 0
                };
                
                stats.passes[team] = 0;
                stats.tackles[team] = 0;
                stats.saves[team] = 0;
            });

            if (!scheduleData) return { 
                overall: [], 
                byGroup: {}, 
                stats: stats 
            };

            // Process matches
            scheduleData.forEach(round => {
                round.matches.forEach(match => {
                    const homeTeam = match.home;
                    const awayTeam = match.away;
                    const homeScore = parseInt(match.homeScore);
                    const awayScore = parseInt(match.awayScore);

                    if (isNaN(homeScore) || isNaN(awayScore)) return;

                    const home = standings[homeTeam];
                    const away = standings[awayTeam];

                    if (!home || !away) return;

                    // Update match counts
                    home.P++;
                    away.P++;

                    // Update goals
                    home.GF += homeScore;
                    home.GA += awayScore;
                    away.GF += awayScore;
                    away.GA += homeScore;

                    // Update results and points
                    if (homeScore > awayScore) {
                        home.W++; home.Pts += 3;
                        away.L++;
                    } else if (awayScore > homeScore) {
                        away.W++; away.Pts += 3;
                        home.L++;
                    } else {
                        home.D++; home.Pts += 1;
                        away.D++; away.Pts += 1;
                    }
                    
                    // HOME TEAM STATS
                    if (match.homePasses) {
                        home.passes += match.homePasses;
                        stats.passes[homeTeam] += match.homePasses;
                    }
                    if (match.homeTackles) {
                        home.tackles += match.homeTackles;
                        stats.tackles[homeTeam] += match.homeTackles;
                    }
                    if (match.homeSaves) {
                        home.saves += match.homeSaves;
                        stats.saves[homeTeam] += match.homeSaves;
                    }

                    // AWAY TEAM STATS
                    if (match.awayPasses) {
                        away.passes += match.awayPasses;
                        stats.passes[awayTeam] += match.awayPasses;
                    }
                    if (match.awayTackles) {
                        away.tackles += match.awayTackles;
                        stats.tackles[awayTeam] += match.awayTackles;
                    }
                    if (match.awaySaves) {
                        away.saves += match.awaySaves;
                        stats.saves[awayTeam] += match.awaySaves;
                    }
                });
            });

            // Calculate GD
            Object.values(standings).forEach(team => {
                team.GD = team.GF - team.GA;
            });

            // Sort overall standings
            const overallStandings = Object.values(standings).sort((a, b) => {
                if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                if (b.GD !== a.GD) return b.GD - a.GD;
                if (b.GF !== a.GF) return b.GF - a.GF;
                return a.team.localeCompare(b.team);
            });

            // Group standings - FIXED: Properly group by team.group property
            const standingsByGroup = {};
            overallStandings.forEach(team => {
                const groupName = team.group;
                if (!standingsByGroup[groupName]) {
                    standingsByGroup[groupName] = [];
                }
                standingsByGroup[groupName].push(team);
            });

            // Sort each group's standings
            for (const groupName in standingsByGroup) {
                standingsByGroup[groupName].sort((a, b) => {
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                    if (b.GD !== a.GD) return b.GD - a.GD;
                    if (b.GF !== a.GF) return b.GF - a.GF;
                    return a.team.localeCompare(b.team);
                });
            }

            return { 
                overall: overallStandings, 
                byGroup: standingsByGroup, 
                stats: stats 
            };
        };

        // ========== RENDERING FUNCTIONS ==========
        const renderNewsStrip = (news) => {
            const container = document.getElementById('news-strip-container');
            const newsText = document.getElementById('news-text');
            
            const visibleTabs = ['fixtures', 'points', 'stats'];
            
            if (news && news.trim() !== "" && visibleTabs.includes(currentTab)) {
                newsText.innerHTML = news;
                container.classList.remove('hidden');
                // Cache news for faster loading
                localStorage.setItem('tournament_news', news);
            } else if (visibleTabs.includes(currentTab)) {
                // Try cached news
                const cachedNews = localStorage.getItem('tournament_news');
                if (cachedNews && cachedNews.trim() !== "") {
                    newsText.innerHTML = cachedNews;
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            } else {
                container.classList.add('hidden');
            }
        };

        const renderAdminResultsContent = (tournament) => {
            const container = document.getElementById('admin-results-content');
            if (!isAdmin || !tournament || !tournament.schedule) {
                container.innerHTML = '<div class="text-center py-8 text-blue-200">Generate a schedule above to start uploading results.</div>';
                return;
            }

            const players = tournament.players || {};
            let html = '';
            
            tournament.schedule.forEach(round => {
                const isKnockout = round.matches.some(m => m.knockout);
                const roundType = isKnockout ? 'Knockout' : (round.matches[0]?.group ? 'Group Stage' : 'League');
                
                html += `
                    <div class="bg-blue-900/30 p-4 rounded-xl mb-6">
                        <h4 class="text-lg font-bold text-blue-200 mb-4">
                            ${isKnockout ? round.matches[0]?.group : 'Matchday'} ${round.round} (${round.date}) - ${roundType}
                        </h4>
                        <div class="space-y-3">
                `;
                
                round.matches.forEach(match => {
                    const homePlayer = getPlayerName(match.home, players);
                    const awayPlayer = getPlayerName(match.away, players);
                    
                    html += `
                        <form data-match-id="${match.id}" class="match-update-form bg-blue-900/50 p-4 rounded-lg border border-blue-700/50">
                            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                                <!-- HOME TEAM -->
                                <div class="flex-1 min-w-[200px]">
                                    <div class="font-bold text-blue-100 text-sm mb-1">${match.home}${homePlayer}</div>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" min="0" value="${match.homeScore || ''}" 
                                               placeholder="0" 
                                               class="score-input-home w-16 p-2 bg-blue-800 border border-blue-600 rounded text-center text-white">
                                        <span class="text-blue-300 font-bold">vs</span>
                                        <input type="number" min="0" value="${match.awayScore || ''}" 
                                               placeholder="0" 
                                               class="score-input-away w-16 p-2 bg-blue-800 border border-blue-600 rounded text-center text-white">
                                    </div>
                                </div>
                                
                                <!-- AWAY TEAM -->
                                <div class="flex-1 min-w-[200px]">
                                    <div class="font-bold text-blue-100 text-sm mb-1">${match.away}${awayPlayer}</div>
                                    <div class="text-blue-300 text-xs">${match.group || ''}</div>
                                </div>
                                
                                <!-- STATS SECTION -->
                                <div class="flex flex-wrap lg:flex-nowrap items-center gap-3">
                                    <!-- HOME TEAM STATS -->
                                    <div class="flex flex-col items-center border-r border-blue-700/50 pr-3">
                                        <div class="text-xs text-green-300 mb-1">${match.home.split(' ')[0]} Passes</div>
                                        <input type="number" min="0" value="${match.homePasses || ''}" 
                                               class="home-passes-input match-stat-input bg-green-900/30 border border-green-600 rounded">
                                    </div>
                                    
                                    <div class="flex flex-col items-center border-r border-blue-700/50 pr-3">
                                        <div class="text-xs text-red-300 mb-1">${match.home.split(' ')[0]} Tackles</div>
                                        <input type="number" min="0" value="${match.homeTackles || ''}" 
                                               class="home-tackles-input match-stat-input bg-red-900/30 border border-red-600 rounded">
                                    </div>
                                    
                                    <div class="flex flex-col items-center border-r border-blue-700/50 pr-3">
                                        <div class="text-xs text-cyan-300 mb-1">${match.home.split(' ')[0]} Saves</div>
                                        <input type="number" min="0" value="${match.homeSaves || ''}" 
                                               class="home-saves-input match-stat-input bg-cyan-900/30 border border-cyan-600 rounded">
                                    </div>
                                    
                                    <!-- AWAY TEAM STATS -->
                                    <div class="flex flex-col items-center border-r border-blue-700/50 pr-3">
                                        <div class="text-xs text-green-300 mb-1">${match.away.split(' ')[0]} Passes</div>
                                        <input type="number" min="0" value="${match.awayPasses || ''}" 
                                               class="away-passes-input match-stat-input bg-green-900/30 border border-green-600 rounded">
                                    </div>
                                    
                                    <div class="flex flex-col items-center border-r border-blue-700/50 pr-3">
                                        <div class="text-xs text-red-300 mb-1">${match.away.split(' ')[0]} Tackles</div>
                                        <input type="number" min="0" value="${match.awayTackles || ''}" 
                                               class="away-tackles-input match-stat-input bg-red-900/30 border border-red-600 rounded">
                                    </div>
                                    
                                    <div class="flex flex-col items-center">
                                        <div class="text-xs text-cyan-300 mb-1">${match.away.split(' ')[0]} Saves</div>
                                        <input type="number" min="0" value="${match.awaySaves || ''}" 
                                               class="away-saves-input match-stat-input bg-cyan-900/30 border border-cyan-600 rounded">
                                    </div>
                                    
                                    <!-- SAVE BUTTON -->
                                    <button type="submit" 
                                            class="ml-2 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all">
                                        <i class="ph-bold ph-floppy-disk text-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    `;
                });
                
                html += `</div></div>`;
            });

            container.innerHTML = html;
            document.querySelectorAll('.match-update-form').forEach(form => {
                form.addEventListener('submit', handleUpdateResult);
            });
        };

        const renderAdminManagementPanel = (tournament) => {
            const container = document.getElementById('current-tournament-status');
            if (!tournament) {
                container.innerHTML = `
                    <div class="p-6 bg-blue-900/30 rounded-xl border border-blue-700 text-center">
                        <i class="ph-bold ph-trophy-simple text-4xl text-blue-400 mb-3"></i>
                        <p class="font-bold text-blue-200">No Active Tournament</p>
                        <p class="text-sm text-blue-300">Create a new tournament below</p>
                    </div>
                `;
                return;
            }

            const standings = calculateStandings(tournament.teams, tournament.schedule, tournament.groups);
            const totalMatches = tournament.schedule.reduce((sum, r) => sum + r.matches.length, 0);
            const matchesPlayed = standings.overall.reduce((sum, t) => sum + t.P, 0) / 2;
            const progress = totalMatches > 0 ? ((matchesPlayed / totalMatches) * 100).toFixed(0) : 0;
            const leader = standings.overall[0]?.team || 'N/A';

            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="bg-blue-900/30 p-4 rounded-lg">
                        <div class="text-sm text-blue-300">Type</div>
                        <div class="text-lg font-bold text-white">${tournament.type === 'league' ? 'League' : 'Group Stage + Knockout'}</div>
                    </div>
                    <div class="bg-blue-900/30 p-4 rounded-lg">
                        <div class="text-sm text-blue-300">Teams</div>
                        <div class="text-lg font-bold text-white">${tournament.teams.length}</div>
                    </div>
                    <div class="bg-blue-900/30 p-4 rounded-lg">
                        <div class="text-sm text-blue-300">Leader</div>
                        <div class="text-lg font-bold text-white truncate">${leader}</div>
                    </div>
                    <div class="bg-blue-900/30 p-4 rounded-lg">
                        <div class="text-sm text-blue-300">Matches</div>
                        <div class="text-lg font-bold text-white">${matchesPlayed}/${totalMatches}</div>
                    </div>
                    <div class="bg-blue-900/30 p-4 rounded-lg">
                        <div class="text-sm text-blue-300">Progress</div>
                        <div class="text-lg font-bold text-white">${progress}%</div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <div class="w-full bg-blue-900/50 rounded-full h-3">
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-3 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="delete-tournament-btn" 
                            class="px-6 py-3 bg-gradient-to-r from-red-600 to-pink-600 text-white font-bold rounded-xl hover:from-red-700 hover:to-pink-700 transition-all">
                        <i class="ph-bold ph-trash-simple mr-2"></i> Delete Tournament
                    </button>
                </div>
            `;
            
            document.getElementById('delete-tournament-btn').addEventListener('click', async () => {
                if (confirm("Are you sure you want to delete the entire tournament?")) {
                    try {
                        await tournamentRef.remove();
                        showMessage('admin-auth-message', 'Tournament deleted successfully.', false);
                    } catch (error) {
                        console.error("Delete error:", error);
                        showMessage('admin-auth-message', 'Failed to delete tournament.', true);
                    }
                }
            });
        };

        // ========== RESTORED FIXTURES DISPLAY WITH GROUP WISE TABS ==========
        const renderFixtures = (tournament) => {
            const container = document.getElementById('fixtures-content');
            const tabContainer = document.getElementById('group-tabs-container');
            const header = document.getElementById('fixtures-header');
            
            if (!tournament || !tournament.schedule) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="ph-bold ph-calendar-blank text-5xl text-blue-400 mb-4"></i>
                        <p class="text-xl text-blue-200">Tournament fixtures will appear here once the schedule is generated.</p>
                    </div>
                `;
                tabContainer.classList.add('hidden');
                return;
            }

            const players = tournament.players || {};
            
            if (tournament.type === 'league') {
                // LEAGUE FIXTURES - No group tabs
                tabContainer.classList.add('hidden');
                header.innerHTML = `<i class="ph-bold ph-calendar-check text-2xl mr-3 text-ucl-accent"></i> League Fixtures`;
                
                let html = '';
                tournament.schedule.forEach((round, index) => {
                    html += `
                        <div class="match-card p-6 mb-6 w-full">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                <h3 class="text-xl font-bold text-white">
                                    Matchday ${round.round} - League Round
                                </h3>
                                <span class="text-blue-300 font-semibold bg-blue-900/50 px-4 py-2 rounded-full">${round.date}</span>
                            </div>
                            <div class="space-y-4">
                    `;
                    
                    round.matches.forEach(match => {
                        const homePlayer = getPlayerName(match.home, players);
                        const awayPlayer = getPlayerName(match.away, players);
                        
                        const homeScore = match.homeScore !== null && match.homeScore !== undefined ? match.homeScore : 'NA';
                        const awayScore = match.awayScore !== null && match.awayScore !== undefined ? match.awayScore : 'NA';
                        
                        const scoreDisplay = match.homeScore !== null && match.homeScore !== undefined ? 
                            `<span class="text-2xl font-bold text-white">${homeScore} - ${awayScore}</span>` :
                            '<span class="text-2xl font-bold text-yellow-400">NA - NA</span>';
                        
                        const matchStatus = match.homeScore !== null && match.homeScore !== undefined ? 
                            'border-green-500/30 bg-green-500/10' : 
                            'border-blue-500/30 bg-blue-500/10';
                        
                        html += `
                            <div class="flex flex-col sm:flex-row items-center justify-between p-4 rounded-xl border-2 ${matchStatus} gap-4">
                                <div class="flex items-center flex-1 w-full sm:w-auto">
                                    <div class="flex-shrink-0 mr-3">
                                        ${getTeamLogoHtml(match.home, 'w-10 h-10')}
                                    </div>
                                    <div class="min-w-0">
                                        <div class="font-bold text-white team-name">${match.home}</div>
                                        <div class="text-sm text-blue-300 truncate">${homePlayer}</div>
                                    </div>
                                </div>
                                
                                <div class="mx-0 sm:mx-6 text-center my-2 sm:my-0">
                                    ${scoreDisplay}
                                </div>
                                
                                <div class="flex items-center flex-1 w-full sm:w-auto justify-end sm:justify-start">
                                    <div class="text-right sm:text-left min-w-0">
                                        <div class="font-bold text-white team-name">${match.away}</div>
                                        <div class="text-sm text-blue-300 truncate">${awayPlayer}</div>
                                    </div>
                                    <div class="flex-shrink-0 ml-3">
                                        ${getTeamLogoHtml(match.away, 'w-10 h-10')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
                
                container.innerHTML = html;
                
            } else if (tournament.type === 'group_knockout' && tournament.groups) {
                // GROUP STAGE + KNOCKOUT FIXTURES - With group tabs
                tabContainer.classList.remove('hidden');
                header.innerHTML = `<i class="ph-bold ph-calendar-check text-2xl mr-3 text-ucl-accent"></i> Tournament Fixtures`;
                
                const groups = Object.keys(tournament.groups).sort();
                
                // Initialize activeGroup if not set
                if (!activeGroup || !groups.includes(activeGroup)) {
                    activeGroup = groups[0];
                }
                
                // Render group tabs
                let tabsHtml = '<div class="flex flex-wrap justify-center sm:justify-start gap-2">';
                groups.forEach(groupName => {
                    const isActive = groupName === activeGroup;
                    const tabClass = isActive ? 
                        'bg-ucl-highlight text-white border-ucl-highlight' : 
                        'bg-blue-900/50 text-blue-300 border-transparent hover:bg-blue-900';
                    
                    tabsHtml += `
                        <div data-group="${groupName}" class="group-tab-button py-2 px-4 rounded-lg text-sm font-semibold border-2 ${tabClass} transition duration-150 cursor-pointer">
                            ${groupName}
                        </div>
                    `;
                });
                tabsHtml += '</div>';
                tabContainer.innerHTML = tabsHtml;
                
                // Add event listeners to group tabs
                document.querySelectorAll('.group-tab-button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newGroup = e.currentTarget.getAttribute('data-group');
                        if (newGroup !== activeGroup) {
                            activeGroup = newGroup;
                            renderFixtures(tournament);
                        }
                    });
                });
                
                // Render fixtures for selected group
                let html = '';
                
                // GROUP STAGE FIXTURES
                const groupMatches = tournament.schedule.filter(round => 
                    round.matches.some(match => match.group === activeGroup && !match.knockout)
                );
                
                if (groupMatches.length > 0) {
                    html += `
                        <div class="match-card p-6 mb-6 w-full">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="ph-bold ph-users-three mr-3 text-ucl-accent"></i> ${activeGroup} Fixtures
                            </h3>
                            <div class="space-y-6">
                    `;
                    
                    groupMatches.forEach(round => {
                        const matchesInGroup = round.matches.filter(m => m.group === activeGroup && !m.knockout);
                        if (matchesInGroup.length === 0) return;
                        
                        html += `
                            <div class="mb-6">
                                <h4 class="text-lg font-bold text-blue-300 mb-4">
                                    Matchday ${round.round} - ${round.date}
                                </h4>
                                <div class="space-y-4">
                        `;
                        
                        matchesInGroup.forEach(match => {
                            const homePlayer = getPlayerName(match.home, players);
                            const awayPlayer = getPlayerName(match.away, players);
                            
                            const homeScore = match.homeScore !== null && match.homeScore !== undefined ? match.homeScore : 'NA';
                            const awayScore = match.awayScore !== null && match.awayScore !== undefined ? match.awayScore : 'NA';
                            
                            const scoreDisplay = match.homeScore !== null && match.homeScore !== undefined ? 
                                `<span class="text-2xl font-bold text-white">${homeScore} - ${awayScore}</span>` :
                                '<span class="text-2xl font-bold text-yellow-400">NA - NA</span>';
                            
                            const matchStatus = match.homeScore !== null && match.homeScore !== undefined ? 
                                'border-green-500/30 bg-green-500/10' : 
                                'border-blue-500/30 bg-blue-500/10';
                            
                            html += `
                                <div class="flex flex-col sm:flex-row items-center justify-between p-4 rounded-xl border-2 ${matchStatus} gap-4">
                                    <div class="flex items-center flex-1 w-full sm:w-auto">
                                        <div class="flex-shrink-0 mr-3">
                                            ${getTeamLogoHtml(match.home, 'w-10 h-10')}
                                        </div>
                                        <div class="min-w-0">
                                            <div class="font-bold text-white team-name">${match.home}</div>
                                            <div class="text-sm text-blue-300 truncate">${homePlayer}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mx-0 sm:mx-6 text-center my-2 sm:my-0">
                                        ${scoreDisplay}
                                    </div>
                                    
                                    <div class="flex items-center flex-1 w-full sm:w-auto justify-end sm:justify-start">
                                        <div class="text-right sm:text-left min-w-0">
                                            <div class="font-bold text-white team-name">${match.away}</div>
                                            <div class="text-sm text-blue-300 truncate">${awayPlayer}</div>
                                        </div>
                                        <div class="flex-shrink-0 ml-3">
                                            ${getTeamLogoHtml(match.away, 'w-10 h-10')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    });
                    
                    html += `</div></div>`;
                } else {
                    html += `<div class="text-center py-8 text-blue-300">No fixtures available for ${activeGroup}</div>`;
                }
                
                // KNOCKOUT STAGE FIXTURES
                const knockoutRounds = tournament.schedule.filter(round => 
                    round.matches.some(match => match.knockout)
                );
                
                if (knockoutRounds.length > 0) {
                    html += `
                        <div class="match-card p-6 mb-6 w-full border-2 border-green-500/30">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="ph-bold ph-trophy mr-3 text-green-400"></i> Knockout Stage
                            </h3>
                            <div class="space-y-6">
                    `;
                    
                    knockoutRounds.forEach(round => {
                        const knockoutMatches = round.matches.filter(m => m.knockout);
                        if (knockoutMatches.length === 0) return;
                        
                        const roundName = knockoutMatches[0].group;
                        
                        html += `
                            <div class="mb-6">
                                <h4 class="text-lg font-bold text-green-400 mb-4 flex items-center">
                                    <i class="ph-bold ph-crown mr-2"></i> ${roundName} - ${round.date}
                                </h4>
                                <div class="space-y-4">
                        `;
                        
                        knockoutMatches.forEach(match => {
                            const homePlayer = getPlayerName(match.home, players);
                            const awayPlayer = getPlayerName(match.away, players);
                            
                            const homeScore = match.homeScore !== null && match.homeScore !== undefined ? match.homeScore : 'NA';
                            const awayScore = match.awayScore !== null && match.awayScore !== undefined ? match.awayScore : 'NA';
                            
                            const scoreDisplay = match.homeScore !== null && match.homeScore !== undefined ? 
                                `<span class="text-2xl font-bold text-white">${homeScore} - ${awayScore}</span>` :
                                '<span class="text-2xl font-bold text-yellow-400">NA - NA</span>';
                            
                            const matchStatus = match.homeScore !== null && match.homeScore !== undefined ? 
                                'border-green-500/30 bg-green-500/20' : 
                                'border-green-500/30 bg-green-500/10';
                            
                            html += `
                                <div class="flex flex-col sm:flex-row items-center justify-between p-4 rounded-xl border-2 ${matchStatus} gap-4">
                                    <div class="flex items-center flex-1 w-full sm:w-auto">
                                        <div class="flex-shrink-0 mr-3">
                                            ${getTeamLogoHtml(match.home, 'w-10 h-10')}
                                        </div>
                                        <div class="min-w-0">
                                            <div class="font-bold text-white team-name">${match.home}</div>
                                            <div class="text-sm text-green-300 truncate">${homePlayer}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mx-0 sm:mx-6 text-center my-2 sm:my-0">
                                        ${scoreDisplay}
                                        <div class="text-xs text-green-400 mt-1">${roundName}</div>
                                    </div>
                                    
                                    <div class="flex items-center flex-1 w-full sm:w-auto justify-end sm:justify-start">
                                        <div class="text-right sm:text-left min-w-0">
                                            <div class="font-bold text-white team-name">${match.away}</div>
                                            <div class="text-sm text-green-300 truncate">${awayPlayer}</div>
                                        </div>
                                        <div class="flex-shrink-0 ml-3">
                                            ${getTeamLogoHtml(match.away, 'w-10 h-10')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    });
                    
                    html += `</div></div>`;
                }
                
                container.innerHTML = html;
            }
        };

        // ========== UPDATED POINTS TABLE FUNCTION (GROUP-WISE FOR GROUP STAGE) ==========
        const renderPointsTable = (standingsResult, players, tournamentType, groups = {}) => {
            const container = document.getElementById('points-table-content');
            const header = document.getElementById('points-header');
            
            if (standingsResult.overall.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="ph-bold ph-table text-5xl text-blue-400 mb-4"></i>
                        <p class="text-xl text-blue-200">Upload results in the Admin tab to populate the points table.</p>
                    </div>
                `;
                return;
            }

            // For group stage tournaments, show group-wise tables
            if (tournamentType === 'group_knockout' && groups && Object.keys(groups).length > 0) {
                header.innerHTML = `<i class="ph-bold ph-list-numbers text-2xl mr-3 text-ucl-accent"></i> Group Stage Standings`;
                
                let html = '';
                const groupNames = Object.keys(groups).sort();
                
                groupNames.forEach(groupName => {
                    const groupTeams = groups[groupName];
                    const groupStandings = standingsResult.byGroup[groupName] || [];
                    
                    // If no standings for this group, create empty standings
                    if (groupStandings.length === 0) {
                        groupTeams.forEach(team => {
                            groupStandings.push({
                                team: team,
                                group: groupName,
                                P: 0, W: 0, D: 0, L: 0,
                                GF: 0, GA: 0, GD: 0, Pts: 0
                            });
                        });
                    }
                    
                    // Sort the group standings
                    groupStandings.sort((a, b) => {
                        if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                        if (b.GD !== a.GD) return b.GD - a.GD;
                        if (b.GF !== a.GF) return b.GF - a.GF;
                        return a.team.localeCompare(b.team);
                    });
                    
                    html += `
                        <div class="mb-10">
                            <h3 class="text-xl font-bold text-white section-header-bg p-4 rounded-xl mb-6 flex items-center">
                                <i class="ph-bold ph-users-three mr-3 text-ucl-accent"></i> ${groupName} Standings
                                <span class="ml-auto text-sm font-normal text-blue-200">
                                    ${groupTeams.length} teams
                                </span>
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse min-w-[800px] mb-6">
                                    <thead>
                                        <tr class="bg-gradient-to-r from-blue-700 to-blue-800">
                                            <th class="p-3 text-left text-white font-bold">#</th>
                                            <th class="p-3 text-left text-white font-bold">Team</th>
                                            <th class="p-3 text-center text-white font-bold">P</th>
                                            <th class="p-3 text-center text-white font-bold hidden sm:table-cell">W</th>
                                            <th class="p-3 text-center text-white font-bold hidden sm:table-cell">D</th>
                                            <th class="p-3 text-center text-white font-bold hidden sm:table-cell">L</th>
                                            <th class="p-3 text-center text-white font-bold">GF</th>
                                            <th class="p-3 text-center text-white font-bold">GA</th>
                                            <th class="p-3 text-center text-white font-bold">GD</th>
                                            <th class="p-3 text-center text-white font-bold">Pts</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    groupStandings.forEach((team, index) => {
                        const isQualifying = index < 2; // Top 2 qualify
                        const rowClass = isQualifying ? 'bg-green-500/20' : 'hover:bg-blue-900/30';
                        const playerName = players[team.team] || '';
                        
                        html += `
                            <tr class="border-b border-blue-800/50 ${rowClass}">
                                <td class="p-3">
                                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${isQualifying ? 'bg-green-500 text-white' : 'bg-blue-900 text-blue-300'} font-bold">
                                        ${index + 1}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center">
                                        ${getTeamLogoHtml(team.team, 'w-8 h-8')}
                                        <div class="ml-3 min-w-0">
                                            <div class="font-bold text-white truncate">${team.team}</div>
                                            <div class="text-xs text-blue-300 truncate">${playerName}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-3 text-center font-bold">${team.P}</td>
                                <td class="p-3 text-center text-green-400 font-bold hidden sm:table-cell">${team.W}</td>
                                <td class="p-3 text-center text-yellow-400 font-bold hidden sm:table-cell">${team.D}</td>
                                <td class="p-3 text-center text-red-400 font-bold hidden sm:table-cell">${team.L}</td>
                                <td class="p-3 text-center font-bold">${team.GF}</td>
                                <td class="p-3 text-center font-bold">${team.GA}</td>
                                <td class="p-3 text-center font-bold ${team.GD > 0 ? 'text-green-400' : team.GD < 0 ? 'text-red-400' : 'text-yellow-400'}">
                                    ${team.GD > 0 ? '+' : ''}${team.GD}
                                </td>
                                <td class="p-3 text-center font-bold text-2xl text-ucl-accent">${team.Pts}</td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table></div>`;
                    
                    // Add qualification info
                    html += `
                        <div class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-700/50">
                            <div class="flex items-center text-sm text-blue-300">
                                <i class="ph-bold ph-info mr-2"></i>
                                <span>Top 2 teams <span class="text-green-400 font-semibold">(highlighted in green)</span> qualify for knockout stage</span>
                            </div>
                        </div>
                    `;
                    
                    html += `</div>`;
                });
                
                container.innerHTML = html;
                
            } else {
                // LEAGUE TOURNAMENT - Single table
                header.innerHTML = `<i class="ph-bold ph-list-numbers text-2xl mr-3 text-ucl-accent"></i> League Standings`;
                
                const standings = standingsResult.overall;
                
                let html = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse min-w-[800px]">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-700 to-blue-800">
                                    <th class="p-3 text-left text-white font-bold">#</th>
                                    <th class="p-3 text-left text-white font-bold">Team</th>
                                    <th class="p-3 text-center text-white font-bold">P</th>
                                    <th class="p-3 text-center text-white font-bold hidden sm:table-cell">W</th>
                                    <th class="p-3 text-center text-white font-bold hidden sm:table-cell">D</th>
                                    <th class="p-3 text-center text-white font-bold hidden sm:table-cell">L</th>
                                    <th class="p-3 text-center text-white font-bold">GF</th>
                                    <th class="p-3 text-center text-white font-bold">GA</th>
                                    <th class="p-3 text-center text-white font-bold">GD</th>
                                    <th class="p-3 text-center text-white font-bold">Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                standings.forEach((team, index) => {
                    const isTop4 = index < 4;
                    const rowClass = isTop4 ? 'bg-green-500/20' : 'hover:bg-blue-900/30';
                    const playerName = players[team.team] || '';
                    
                    html += `
                        <tr class="border-b border-blue-800/50 ${rowClass}">
                            <td class="p-3">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${isTop4 ? 'bg-green-500 text-white' : 'bg-blue-900 text-blue-300'} font-bold">
                                    ${index + 1}
                                </span>
                            </td>
                            <td class="p-3">
                                <div class="flex items-center">
                                    ${getTeamLogoHtml(team.team, 'w-8 h-8')}
                                    <div class="ml-3 min-w-0">
                                        <div class="font-bold text-white truncate">${team.team}</div>
                                        <div class="text-xs text-blue-300 truncate">${playerName}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-3 text-center font-bold">${team.P}</td>
                            <td class="p-3 text-center text-green-400 font-bold hidden sm:table-cell">${team.W}</td>
                            <td class="p-3 text-center text-yellow-400 font-bold hidden sm:table-cell">${team.D}</td>
                            <td class="p-3 text-center text-red-400 font-bold hidden sm:table-cell">${team.L}</td>
                            <td class="p-3 text-center font-bold">${team.GF}</td>
                            <td class="p-3 text-center font-bold">${team.GA}</td>
                            <td class="p-3 text-center font-bold ${team.GD > 0 ? 'text-green-400' : team.GD < 0 ? 'text-red-400' : 'text-yellow-400'}">
                                ${team.GD > 0 ? '+' : ''}${team.GD}
                            </td>
                            <td class="p-3 text-center font-bold text-2xl text-ucl-accent">${team.Pts}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
                
                // Add league info
                html += `
                    <div class="mt-6 p-4 bg-blue-900/30 rounded-lg border border-blue-700/50">
                        <div class="flex items-center text-sm text-blue-300">
                            <i class="ph-bold ph-info mr-2"></i>
                            <span>Top 4 teams <span class="text-green-400 font-semibold">(highlighted in green)</span> are in Champions League positions</span>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
        };

        const renderStats = (standingsResult, players) => {
            // Golden Boot (Top Scorers)
            const topScorers = [...standingsResult.overall]
                .sort((a, b) => b.GF - a.GF)
                .slice(0, 5);
            
            let scorersHtml = '';
            topScorers.forEach((team, index) => {
                const playerName = players[team.team] || '';
                scorersHtml += `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-blue-800/20">
                        <div class="flex items-center min-w-0">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-yellow-500/20 text-yellow-400 font-bold mr-3 flex-shrink-0">
                                ${index + 1}
                            </span>
                            <div class="min-w-0">
                                <div class="font-semibold text-white truncate">${team.team}</div>
                                <div class="text-xs text-blue-300 truncate">${playerName}</div>
                            </div>
                        </div>
                        <span class="font-bold text-yellow-400 ml-2 flex-shrink-0">${team.GF} goals</span>
                    </li>
                `;
            });
            document.getElementById('scorers-list').innerHTML = scorersHtml || '<li class="text-blue-300 text-center p-3">No data</li>';

            // Best Defense
            const bestDefense = [...standingsResult.overall]
                .sort((a, b) => a.GA - b.GA)
                .slice(0, 5);
            
            let defenseHtml = '';
            bestDefense.forEach((team, index) => {
                const playerName = players[team.team] || '';
                defenseHtml += `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-blue-800/20">
                        <div class="flex items-center min-w-0">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500/20 text-blue-400 font-bold mr-3 flex-shrink-0">
                                ${index + 1}
                            </span>
                            <div class="min-w-0">
                                <div class="font-semibold text-white truncate">${team.team}</div>
                                <div class="text-xs text-blue-300 truncate">${playerName}</div>
                            </div>
                        </div>
                        <span class="font-bold text-blue-400 ml-2 flex-shrink-0">${team.GA} conceded</span>
                    </li>
                `;
            });
            document.getElementById('defense-list').innerHTML = defenseHtml || '<li class="text-blue-300 text-center p-3">No data</li>';

            // Top Passers
            const stats = standingsResult.stats;
            const topPassers = Object.entries(stats.passes || {})
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            let passersHtml = '';
            topPassers.forEach(([teamName, passes], index) => {
                const playerName = players[teamName] || '';
                passersHtml += `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-blue-800/20">
                        <div class="flex items-center min-w-0">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-green-500/20 text-green-400 font-bold mr-3 flex-shrink-0">
                                ${index + 1}
                            </span>
                            <div class="min-w-0">
                                <div class="font-semibold text-white truncate">${teamName}</div>
                                <div class="text-xs text-blue-300 truncate">${playerName}</div>
                            </div>
                        </div>
                        <span class="font-bold text-green-400 ml-2 flex-shrink-0">${passes}</span>
                    </li>
                `;
            });
            document.getElementById('passers-list').innerHTML = passersHtml || '<li class="text-blue-300 text-center p-3">No data</li>';

            // Top Tacklers
            const topTacklers = Object.entries(stats.tackles || {})
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            let tacklersHtml = '';
            topTacklers.forEach(([teamName, tackles], index) => {
                const playerName = players[teamName] || '';
                tacklersHtml += `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-blue-800/20">
                        <div class="flex items-center min-w-0">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-red-500/20 text-red-400 font-bold mr-3 flex-shrink-0">
                                ${index + 1}
                            </span>
                            <div class="min-w-0">
                                <div class="font-semibold text-white truncate">${teamName}</div>
                                <div class="text-xs text-blue-300 truncate">${playerName}</div>
                            </div>
                        </div>
                        <span class="font-bold text-red-400 ml-2 flex-shrink-0">${tackles}</span>
                    </li>
                `;
            });
            document.getElementById('tacklers-list').innerHTML = tacklersHtml || '<li class="text-blue-300 text-center p-3">No data</li>';

            // Top Savers
            const topSavers = Object.entries(stats.saves || {})
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            let saversHtml = '';
            topSavers.forEach(([teamName, saves], index) => {
                const playerName = players[teamName] || '';
                saversHtml += `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-blue-800/20">
                        <div class="flex items-center min-w-0">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-cyan-500/20 text-cyan-400 font-bold mr-3 flex-shrink-0">
                                ${index + 1}
                            </span>
                            <div class="min-w-0">
                                <div class="font-semibold text-white truncate">${teamName}</div>
                                <div class="text-xs text-blue-300 truncate">${playerName}</div>
                            </div>
                        </div>
                        <span class="font-bold text-cyan-400 ml-2 flex-shrink-0">${saves}</span>
                    </li>
                `;
            });
            document.getElementById('savers-list').innerHTML = saversHtml || '<li class="text-blue-300 text-center p-3">No data</li>';

            // Miscellaneous stats
            const totalMatches = standingsResult.overall.reduce((sum, t) => sum + t.P, 0) / 2;
            const totalGoals = standingsResult.overall.reduce((sum, t) => sum + t.GF, 0);
            const totalPasses = Object.values(stats.passes || {}).reduce((sum, p) => sum + p, 0);
            const totalTackles = Object.values(stats.tackles || {}).reduce((sum, t) => sum + t, 0);
            const totalSaves = Object.values(stats.saves || {}).reduce((sum, s) => sum + s, 0);
            
            document.getElementById('stats-misc').innerHTML = `
                <div class="flex flex-wrap justify-center gap-4 text-sm">
                    <span class="flex items-center bg-blue-900/30 px-3 py-2 rounded-lg">
                        <i class="ph-bold ph-soccer-ball mr-2 text-green-400"></i>
                        ${totalGoals} total goals
                    </span>
                    <span class="flex items-center bg-blue-900/30 px-3 py-2 rounded-lg">
                        <i class="ph-bold ph-arrows-left-right mr-2 text-green-400"></i>
                        ${totalPasses} passes
                    </span>
                    <span class="flex items-center bg-blue-900/30 px-3 py-2 rounded-lg">
                        <i class="ph-bold ph-sword mr-2 text-red-400"></i>
                        ${totalTackles} tackles
                    </span>
                    <span class="flex items-center bg-blue-900/30 px-3 py-2 rounded-lg">
                        <i class="ph-bold ph-hand mr-2 text-cyan-400"></i>
                        ${totalSaves} saves
                    </span>
                </div>
            `;
        };

        // ========== TAB MANAGEMENT ==========
        const switchTab = (tabName) => {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                const isSelected = btn.getAttribute('data-tab') === tabName;
                btn.classList.toggle('bg-blue-900', isSelected);
                btn.classList.toggle('border-ucl-accent', isSelected);
                btn.classList.toggle('border-transparent', !isSelected);
            });
            
            // Show/hide tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== tabName);
            });
            
            // Handle specific tab logic
            if (tabName === 'admin' && isAdmin && tournamentData) {
                renderAdminManagementPanel(tournamentData);
                renderAdminResultsContent(tournamentData);
            }
            
            if (tabName === 'stats' && tournamentData) {
                const standings = calculateStandings(tournamentData.teams, tournamentData.schedule, tournamentData.groups);
                renderStats(standings, tournamentData.players);
            }
            
            // Update news strip visibility - Show cached news immediately
            const cachedNews = localStorage.getItem('tournament_news');
            if (cachedNews && ['fixtures', 'points', 'stats'].includes(currentTab)) {
                const newsText = document.getElementById('news-text');
                const container = document.getElementById('news-strip-container');
                newsText.innerHTML = cachedNews;
                container.classList.remove('hidden');
            }
            
            // Also load from Firebase for updates
            newsRef.once('value', snapshot => {
                const liveNews = snapshot.val();
                if (liveNews && liveNews.trim() !== "") {
                    renderNewsStrip(liveNews);
                }
            });
        };

        // ========== INITIALIZATION ==========
        const initializeApp = () => {
            // Set default date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            
            // Event Listeners
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
            });
            
            document.getElementById('admin-auth-form').addEventListener('submit', handleAdminAuth);
            document.getElementById('start-tournament-form').addEventListener('submit', handleStartTournament);
            
            // News functionality
            document.getElementById('publish-news-btn').addEventListener('click', () => {
                const newsText = document.getElementById('admin-news-input').value.trim();
                if (newsText) {
                    newsRef.set(newsText);
                    showMessage('start-message', 'News published successfully!', false);
                    document.getElementById('admin-news-input').value = '';
                } else {
                    showMessage('start-message', 'Please enter some news text.', true);
                }
            });
            
            document.getElementById('clear-news-btn').addEventListener('click', () => {
                newsRef.remove();
                localStorage.removeItem('tournament_news');
                showMessage('start-message', 'News cleared successfully!', false);
            });
            
            // Tournament type toggle
            document.getElementById('tournament-type').addEventListener('change', (e) => {
                const isLeague = e.target.value === 'league';
                document.getElementById('league-rounds-container').classList.toggle('hidden', !isLeague);
                document.getElementById('group-stage-options').classList.toggle('hidden', isLeague);
            });
            
            // Initialize with fixtures tab
            switchTab('fixtures');
        };

        // ========== FIREBASE REALTIME LISTENER ==========
        tournamentRef.on('value', (snapshot) => {
            tournamentData = snapshot.val();
            
            if (tournamentData) {
                const standings = calculateStandings(tournamentData.teams, tournamentData.schedule, tournamentData.groups);
                
                // Always update visible tabs
                renderFixtures(tournamentData);
                renderPointsTable(standings, tournamentData.players, tournamentData.type, tournamentData.groups);
                
                // Update admin panel if visible
                if (isAdmin || currentTab === 'admin') {
                    renderAdminManagementPanel(tournamentData);
                }
                
                // Update stats if visible
                if (currentTab === 'stats') {
                    renderStats(standings, tournamentData.players);
                }
            } else {
                // No tournament data
                renderFixtures(null);
                renderPointsTable({ overall: [], byGroup: {}, stats: {} }, null, 'league');
                if (currentTab === 'stats') {
                    renderStats({ overall: [], stats: {} });
                }
            }
        }, (error) => {
            console.error("Database error:", error);
        });

        // News listener
        newsRef.on('value', (snapshot) => {
            renderNewsStrip(snapshot.val());
        });

    </script>
</body>
</html>
